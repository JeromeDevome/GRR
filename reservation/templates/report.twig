{% extends 'layout.twig' %}

{% import 'messagesysteme.twig' as msgSyst %}
{% import 'champs.twig' as form %}

{% block css %}
<style>
/* Pagination v2 */
.dataTables_paginate .paginate_button {
    padding: 0.375rem 0.75rem;
    margin: 0 0.1rem;
    border-radius: 0.25rem;
    border: 1px solid #dee2e6;
    color: #0d6efd;
    background: #fff;
    cursor: pointer;
}
.dataTables_paginate .paginate_button.current {
    background-color: #0d6efd !important;
    color: #fff !important;
}
.dataTables_paginate .paginate_button:hover {
    background-color: #0b5ed7 !important;
    color: #fff !important;
}
/* Conteneur pagination */
.dt-paging {
    display: flex;
    justify-content: flex-end;
}

/* Boutons pagination */
.dt-paging-button {
    padding: 0.375rem 0.75rem;
    margin-left: 0.25rem;
    border-radius: 0.25rem;
    border: 1px solid #dee2e6;
    background-color: #fff;
    color: #0d6efd;
    cursor: pointer;
    font-size: 16px;
}

/* Bouton actif */
.dt-paging-button.current {
    background-color: #0d6efd;
    color: #fff;
    border-color: #0d6efd;
}

/* Hover */
.dt-paging-button:hover:not(.current):not(.disabled) {
    background-color: #e9ecef;
    color: #0d6efd;
}

/* Désactivé */
.dt-paging-button.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.dt-length select {
    display: inline-block;
    width: auto;
    margin-left: 0.25rem;
}

/* Supprimer le texte autour du select */
.dt-length label {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    margin-bottom: 0;
}

/* Garder uniquement le select */
.dt-length label::before,
.dt-length label::after {
    display: none !important;
}

.dt-button-collection {
    padding: 0.25rem;
    background: #fff;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    box-shadow: 0 .5rem 1rem rgba(0,0,0,.15);
}

.dt-button-collection button {
    display: block;
    width: 100%;
    margin: 0;
    padding: 0.25rem 0.5rem;
    text-align: left;
    border: none;
    background: transparent;
    color: #212529;
}

.dt-button-collection button:hover {
    background-color: #e9ecef;
    color: #212529;
}
.dt-button-collection.dropdown-menu {
    position: absolute !important;
    top: 100% !important;
    left: 0 !important;
    z-index: 1000;
    min-width: 10rem;
    padding: 0.25rem 0;
    margin: 0.125rem 0 0;
    font-size: 1rem;
    color: #212529;
    text-align: left;
    background-color: #fff;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    box-shadow: 0 .5rem 1rem rgba(0,0,0,.15);
}

</style>
{% endblock %}


{% block content %}

<div id="page-resa" class="col col-lg-12 col-md-12 col-xs-12">

	<h1 class="center">{{ trad.search_report_stats }}</h1>

	<form id="frmReport" method="get" action="?p=report">
		<input type="hidden" name="p" value="report">
		<input type="hidden" name="is_posted" value="y">

		<div class="col col-lg-4 col-md-4 col-xs-12">{{ trad.report_start }}{{ trad.deux_points }}</div>
		<div class="col col-lg-8 col-md-8 col-xs-12">{{ d.jQuery_DatePickerDebut |raw }}</div>

		<div class="col col-lg-4 col-md-4 col-xs-12">{{ trad.report_end }}{{ trad.deux_points }}</div>
		<div class="col col-lg-8 col-md-8 col-xs-12">{{ d.jQuery_DatePickerFin |raw }}</div>

		<div class="col col-lg-12 col-md-12 col-xs-12"><input type="radio" name="condition_et_ou" value="AND" {{ d.checkedAND }}> {{ trad.valide_toutes_les_conditions_suivantes }}</div>
		<div class="col col-lg-12 col-md-12 col-xs-12"><input type="radio" name="condition_et_ou" value="OR" {{ d.checkedOR }}> {{ trad.valide_au_moins_une_des_conditions_suivantes }}</div>

		{% for condition in conditions %}
			<div class="col col-lg-12 col-md-12 col-xs-12">
				<div class="form-inline">
					<div class="form-group">
						<select class="form-control" name="champ[]" size="1">
							<option value="" {%if condition.selectCritere == "" %}selected{%endif%}>{{ trad.choose }}</option>
							{% if settings.module_multisite == "Oui" %}
							<option value="site" {%if condition.selectCritere == "site" %}selected{%endif%}>{{ trad.site }}</option>
							{% endif %}
							<option value="area" {%if condition.selectCritere == "area" %}selected{%endif%}>{{ trad.match_area }}</option>
							<option value="room" {%if condition.selectCritere == "room" %}selected{%endif%}>{{ trad.room }}</option>
							<option value="type" {%if condition.selectCritere == "type" %}selected{%endif%}>{{ trad.type }}</option>
							<option value="name" {%if condition.selectCritere == "name" %}selected{%endif%}>{{ trad.namebooker }}</option>
                            <option value="descr" {%if condition.selectCritere == "descr" %}selected{%endif%}>{{ trad.match_descr }}</option>
							<option value="login" {%if condition.selectCritere == "login" %}selected{%endif%}>{{ trad.match_login }}</option>
							{% for champadd in condition.champAdd %}
								<option value="addon_{{champadd.id}}" {%if champadd.select == 1 %}selected{%endif%}>{{champadd.nom}}</option>
							{% endfor %}
						</select>
					</div>
					<div class="form-group">
						<select class="form-control" name="type_recherche[]" size="1">
							<option value="1" {%if condition.selectType == 1 %}selected{%endif%}>{{ trad.contient }}{{ trad.deux_points }}</option>
							<option value="0" {%if condition.selectType == 0 %}selected{%endif%}>{{ trad.ne_contient_pas }}{{ trad.deux_points }}</option>
						</select>
					</div>
					<div class="form-group">
						<input class="form-control" type="text" name="texte[]" value="{{condition.motRecherche}}" size="20" />
					</div>
				</div>						
			</div>
		{% endfor %}

		<p>{{ trad.include }}{{ trad.deux_points }}</p>
		<div class="col col-lg-12 col-md-12 col-xs-12"><input type="radio" name="summarize" value="1" {% if d.summarize == 1 %}checked{%endif%}> {{ trad.report_only }}</div>
		<div class="col col-lg-12 col-md-12 col-xs-12"><input type="radio" name="summarize" value="2" {% if d.summarize == 2 %}checked{%endif%}> {{ trad.summary_only }}</div>
		<div class="col col-lg-12 col-md-12 col-xs-12"><input type="radio" name="summarize" value="3" {% if d.summarize == 3 %}checked{%endif%}> {{ trad.report_and_summary }}</div>

		<div class="col col-lg-4 col-md-4 col-xs-12">{{ trad.summarize_by }} {{ trad.summarize_by_precisions }}{{ trad.deux_points }}</div>
		<div class="col col-lg-8 col-md-8 col-xs-12">
			<select class="form-control" name="sumby" size="1">
				<option value="6" {%if d.sumby == "6" %}selected{%endif%}>{{ trad.sum_by_creator }}</option>
				<option value="3" {%if d.sumby == "3" %}selected{%endif%}>{{ trad.sum_by_descrip }}</option>
				<option value="5" {%if d.sumby == "5" %}selected{%endif%}>{{ trad.type }}</option>
				{% for champadd in champsaddresume %}
					<option value="addon_{{champadd.id}}" {%if champadd.select == 1 %}selected{%endif%}>{{champadd.nom}}</option>
				{% endfor %}
			</select>
		</div>
		<div>
			<input class="btn btn-primary" type="submit" name="submit" value="{{trad.submit}}">
		</div>
	</form>

	{%if d.resultat == 1 %}
		<div class="col col-xs-12">

			<hr>
			{%if d.nbResultat == 0 %}
				<p><b>{{ trad.nothing_found }}</b></p>
			{% else %}
				<p><b>{{ d.nbResultat }} {%if d.nbResultat == 1 %}{{ trad.entry_found }}{% else %}{{ trad.entries_found }}{% endif %}</b></p>

				{%if d.summarize == 1 or d.summarize == 3 %}
					<div id="example_wrapper" class="dataTables_wrapper form-inline dt-bootstrap">

						<div class="row">
							<div class="col col-sm-12">
								<table id="example" class="table table-striped table-bordered dataTable" style="width: 100%;" role="grid" aria-describedby="example_info">
									<thead>
										<tr role="row">
											{% if settings.module_multisite == "Oui" %}
												<th class="sorting" tabindex="0" aria-controls="example" rowspan="1" colspan="1">{{trad.site}}</th>
											{% endif %}
											<th class="sorting sorting_desc" tabindex="0" aria-controls="example" rowspan="1" colspan="1">{{trad.match_area}}</th>
											<th class="sorting" tabindex="0" aria-controls="example" rowspan="1" colspan="1">{{trad.room}}</th>
											<th class="sorting" tabindex="0" aria-controls="example" rowspan="1" colspan="1">{{trad.namebooker}}</th>
                                            <th class="sorting" tabindex="0" aria-controls="example" rowspan="1" colspan="1">{{trad.date}}</th>
											<th class="sorting" tabindex="0" aria-controls="example" rowspan="1" colspan="1">{{trad.time}}</th>
											<th class="sorting" tabindex="0" aria-controls="example" rowspan="1" colspan="1">{{trad.duration}}</th>
                                            <th class="sorting" tabindex="0" aria-controls="example" rowspan="1" colspan="1">{{trad.datefin}}</th>
											<th class="sorting" tabindex="0" aria-controls="example" rowspan="1" colspan="1">{{trad.time}}</th>
											<th class="sorting" tabindex="0" aria-controls="example" rowspan="1" colspan="1">{{trad.match_descr}}</th>
											<th class="sorting" tabindex="0" aria-controls="example" rowspan="1" colspan="1">{{trad.type}}</th>
											<th class="sorting" tabindex="0" aria-controls="example" rowspan="1" colspan="1">{{trad.match_login}}</th>
											<th class="sorting" tabindex="0" aria-controls="example" rowspan="1" colspan="1">{{trad.lastupdate}}</th>
											<th class="sorting" tabindex="0" aria-controls="example" rowspan="1" colspan="1">{{trad.moderation}}</th>
											{% for champadd in champsaddresume %}
												<th class="sorting" tabindex="0" aria-controls="example" rowspan="1" colspan="1">{{champadd.nom}}</th>
											{% endfor %}
										</tr>
									</thead>
									<tbody>
										{% for resa in listeresa %}
											<tr class="odd">
												{% if settings.module_multisite == "Oui" %}
													<td>{{resa.site}}</td>
												{% endif %}
												<td title="{{resa.domainedesc}}">{{resa.domaine}}</td>
												<td>{{resa.ressource}}</td>
												<td><a href="app.php?p=vuereservation&amp;id={{resa.idresa}}">{{resa.descriptionc}}</a></td>
												<td data-order="{{resa.datedebutts}}">{{resa.datedebut}}</td>
                                                <td>{{resa.heuredebut}}</td>
												<td>{{resa.duree}}</td>
												<td data-order="{{resa.datefints}}">{{resa.datefin}}</td>
												<td>{{resa.heurefin}}</td>
												<td>{{resa.descriptionl|raw}}</td>
												<td>{{resa.type}}</td>
												<td>{{resa.beneficiaire}}</td>
												<td data-order="{{resa.datemajts}}">{{resa.datemaj}}</td>
												<td>
													{% if resa.moderate == 1 %}
														{{trad.en_attente_moderation}}
													{% elseif resa.moderate == 2 %}
														{{trad.moderation_acceptee}}
													{% elseif resa.moderate == 3 %}
														{{trad.moderation_refusee}}
													{% endif %}
												</td>

												{% for champaddval in resa.champaddvaleur %}
													<td>{{champaddval.val}}</td>
												{% endfor %}
											</tr>
										{% endfor %}
									</tbody>
									<tfoot>
										<tr>
											{% if settings.module_multisite == "Oui" %}
											<th rowspan="1" colspan="1">{{trad.site}}</th>
											{% endif %}
											<th rowspan="1" colspan="1">{{trad.match_area}}</th>
											<th rowspan="1" colspan="1">{{trad.room}}</th>
											<th rowspan="1" colspan="1">{{trad.namebooker}}</th>
                                            <th rowspan="1" colspan="1">{{trad.date}}</th>
											<th rowspan="1" colspan="1">{{trad.time}}</th>
											<th rowspan="1" colspan="1">{{trad.duration}}</th>
											<th rowspan="1" colspan="1">{{trad.datefin}}</th>
											<th rowspan="1" colspan="1">{{trad.time}}</th>
											<th rowspan="1" colspan="1">{{trad.match_descr}}</th>
											<th rowspan="1" colspan="1">{{trad.type}}</th>
											<th rowspan="1" colspan="1">{{trad.match_login}}</th>
											<th rowspan="1" colspan="1">{{trad.lastupdate}}</th>
											<th rowspan="1" colspan="1">{{trad.moderation}}</th>
											{% for champadd in champsaddresume %}
												<th rowspan="1" colspan="1">{{champadd.nom}}</th>
											{% endfor %}
										</tr>
									</tfoot>
								</table>
							</div>
						</div>
						<div class="row">
							<div class="col col-sm-5"><div class="dataTables_info" id="example_info" role="status" aria-live="polite"></div></div>
							<div class="col col-sm-7"><div class="dataTables_paginate paging_simple_numbers" id="example_paginate"><ul class="pagination"></ul></div></div>
						</div>
					</div>
				{% endif %}
				{% if d.summarize == 2 or d.summarize == 3 %}
					<h1>{% if d.enablePeriods == y %}{{ trad.summary_header_per }}{% else %}{{ trad.summary_header }}{% endif %}</h1>
					<div id="resume_wrapper" class="dataTables_wrapper form-inline dt-bootstrap">

						<div class="row">
							<div class="col col-sm-12">
								<table id="resume" class="table table-striped table-bordered dataTable" style="width: 100%;" role="grid" aria-describedby="example_info">
									<thead>
										<tr role="row">
											{{listeresume.premLigne |raw}}
										</tr>
									</thead>
									<tbody>
											{% for lignex in listeresume.xLignes %}
												<tr class="odd">{{lignex.ligne |raw}}</tr>
											{% endfor %}
											<tr>
												{{listeresume.dernLigne |raw}}
											</tr>
									</tbody>
									<tfoot>
										<tr>{{listeresume.footLigne |raw}}</tr>
									</tfoot>
								</table>
							</div>
						</div>
						<div class="row">
							<div class="col col-sm-5"><div class="dataTables_info" id="resume_info" role="status" aria-live="polite"></div></div>
							<div class="col col-sm-7"><div class="dataTables_paginate paging_simple_numbers" id="resume_paginate"><ul class="pagination"></ul></div></div>
						</div>
					</div>
				{% endif %}
			{% endif %}
		</div>
	{% endif %}

</div>

{% endblock %}

{% block javascript %}
<!-- DataTables v2 -->
<script src="jslib/datatables/dataTables.min.js"></script>

<!-- Buttons v2 -->
<script src="jslib/datatables-buttons/js/dataTables.buttons.min.js"></script>
<script src="jslib/datatables-buttons/js/buttons.html5.min.js"></script>
<script src="jslib/datatables-buttons/js/buttons.print.min.js"></script>
<script src="jslib/datatables-buttons/js/buttons.colVis.min.js"></script>

<!-- Excel / PDF -->
<script src="js/jszip.min.js"></script>
<script src="jslib/pdfmake/pdfmake.min.js"></script>
<script src="jslib/pdfmake/vfs_fonts.js"></script>

<script>
$(document).ready(function() {

    // ===== Table principale #example =====
    var table = $('#example').DataTable({
		lengthChange: true,
        lengthMenu: [[10, 25, 50, 100, -1],[10, 25, 50, 100, 'All']],
		dom:
			"<'row mb-2'<'col-sm-4 d-flex align-items-center'l<'ms-2'B>><'col-sm-8 d-flex justify-content-end'f>>" +
			"<'row'<'col-sm-12'tr>>" +
			"<'row mt-2'<'col-sm-5'i><'col-sm-7 d-flex justify-content-end'p>>",

        pagingType: 'full_numbers', // Pagination complète
		buttons: [
			{
				extend: 'copy',
				className: 'btn btn-primary',
				exportOptions: {
					columns: ':visible'
				}
			},
			{
				extend: 'excel',
				className: 'btn btn-success',
				exportOptions: {
					columns: ':visible'
				}
			},
			{
				extend: 'csv',
				className: 'btn btn-info',
				exportOptions: {
					columns: ':visible'
				}
			},
			{
				extend: 'pdfHtml5',
				className: 'btn btn-danger',
				orientation: 'landscape',
				pageSize: 'LEGAL',
				exportOptions: {
					columns: ':visible'
				}
			},
			{
				extend: 'colvis',
				className: 'btn btn-secondary dropdown-toggle', // style Bootstrap
				text: 'Colonnes',
				collectionLayout: 'fixed two-column', // optionnel
				postfixButtons: [], // aucun bouton supplémentaire
				collectionTitle: 'Colonnes visibles',
				init: function(api, node, config) {
					// Ajouter la classe Bootstrap dropdown-menu à la collection
					$(node).on('click', function() {
						setTimeout(() => {
							$('.dt-button-collection')
								.addClass('dropdown-menu')
								.css('display', 'block');
							$('.dt-button-collection button').each(function() {
								$(this).addClass('dropdown-item'); // style chaque item
							});
						}, 10);
					});
				}
			}
		],
		language: {
			lengthMenu: "_MENU_",
			search: "",
			searchPlaceholder: "Rechercher..."
        },
		initComplete: function () {
			$('.dt-input[type="search"]')
				.addClass('form-control')
				.css('width', '250px');

			$('.dt-length select')
				.addClass('form-select')
				.css('width', 'auto');
		}

    });

    table.buttons().container().appendTo('#example_wrapper .col-sm-6:eq(0)');

    // ===== Table résumé #resume =====
    var resumeTable = $('#resume').DataTable({
        lengthChange: false,
        dom: 'Bfrtip',
        pagingType: 'full_numbers',
        buttons: [
            { extend: 'copy', className: 'dt-btn dt-btn-primary' },
            { extend: 'excel', className: 'dt-btn dt-btn-success' },
            { extend: 'csv', className: 'dt-btn dt-btn-info' },
            { extend: 'pdfHtml5', className: 'dt-btn dt-btn-danger', orientation: 'landscape', pageSize: 'LEGAL' },
			{ extend: 'colvis', className: 'dt-btn dt-btn-secondary' }
        ],
        language: {
            search: "_INPUT_",
            searchPlaceholder: "Rechercher..."
        }
    });

    resumeTable.buttons().container().appendTo('#resume_wrapper .col-sm-6:eq(0)');

});
</script>
{% endblock %}